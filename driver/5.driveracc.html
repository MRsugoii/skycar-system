<!doctype html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>歷史帳單</title>
<style>
:root{
  --teal:#2B7CFF; --text:#051D4B; --muted:#6b7b80; --line:#e7f0f1; --bg:#f6f8fb;
  --radius:18px; --radius-ipt:16px;
}
html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,"Noto Sans TC",Arial;color:var(--text)}
#page{width:390px;max-width:390px;margin:0 auto;padding:16px 16px 40px}
.h1{font-size:22px;font-weight:900;margin:16px 0 6px;text-align:center}
.muted{color:var(--muted);font-size:12px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.04)}

/* 篩選列 */
.filters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:6px 0 10px}
.chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);cursor:pointer;font-weight:700;background:#fff}
.chip.active{background:#e8f1ff;border-color:#cfe1ff;color:#1b5cff}

/* 表格（卡片式，與未領取薪資一致） */
.tbl{width:100%;border-collapse:separate;border-spacing:0 14px;table-layout:fixed}
.tbl.responsive tbody>tr{
  display:grid;grid-template-columns:1fr auto;gap:8px;border:1px solid var(--line);
  border-radius:14px;padding:14px;background:#fff;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.03)
}
.tbl.responsive td{border:none;padding:0;background:transparent;white-space:normal;overflow-wrap:anywhere}
.t-id{font-weight:700;font-size:15px;letter-spacing:.2px;color:#0d2a66;line-height:1.3}
.t-right{text-align:right}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#f4f8ff}

/* 合計 & 分隔線 */
.sumline{display:flex;justify-content:space-between;align-items:center;font-weight:900;margin-top:6px}
.sep{height:1px;background:var(--line);margin:12px 0}
.money{color:#2B7CFF;font-weight:900}
.center{display:flex;justify-content:center}

/* 返回鍵（下方置中、藍色外框） */
.btn-outline{
  display:inline-flex;align-items:center;justify-content:center;
  padding:12px 24px;border-radius:50px;border:2px solid var(--teal);
  background:transparent;color:var(--teal);font-weight:900;font-size:16px;cursor:pointer;transition:.2s;
}
.btn-outline:hover{background:var(--teal);color:#fff}

/* 彈窗 */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.28);z-index:9999;padding:12px}
.modal.active{display:flex}
.modal-box{width:100%;max-width:390px;max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin:0 0 10px}
.modal-title{font-size:18px;font-weight:900;color:var(--text);margin:0}
.modal-close{cursor:pointer;font-size:20px;color:var(--muted);font-weight:700;background:transparent;border:0}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px}
.kv .key{font-weight:800}
.timestamp{font-variant-numeric:tabular-nums}

/* 年月選擇區（先選時間） */
.filter-time{
  display:flex;
  gap:10px;
  justify-content:center;
  margin:12px 0 16px;
}
.filter-select{
  flex:1;
  max-width:160px;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  background:#fff url('data:image/svg+xml;utf8,<svg fill="%232B7CFF" height="14" viewBox="0 0 24 24" width="14" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 12px center;
  background-size:14px;
  border:1.6px solid var(--line);
  border-radius:999px;
  padding:10px 36px 10px 14px;
  font-weight:700;
  font-size:15px;
  color:var(--text);
  cursor:pointer;
}
.filter-select:hover,
.filter-select:focus{
  border-color:#a8c3ff;
  box-shadow:0 0 0 3px rgba(43,124,255,.1);
  outline:none;
}
</style>
</head>
<body>

<a class="back" href="https://chihang-go.com/" aria-label="返回帳戶頁" style="position:fixed;left:10px;top:10px;z-index:10;width:38px;height:38px;border-radius:50%;background:#fff;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(0,0,0,.08)">
  <svg viewBox="0 0 24 24" fill="none" stroke="#2B7CFF" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><path d="M15 18l-6-6 6-6"/></svg>
</a>

<div id="page">
  <div class="h1">歷史帳單</div>

    <!-- 年月選擇區 -->
  <div class="filter-time">
    <select id="yearFilter" class="filter-select"><option value="">選擇年份</option></select>
    <select id="monthFilter" class="filter-select"><option value="">選擇月份</option></select>
  </div>

  <!-- 狀態篩選列（初始隱藏） -->
  <div class="filters" id="statusFilters" style="display:none;">
    <div class="chip active" data-filter="all">全部</div>
    <div class="chip" data-filter="unreq">未申請</div>
    <div class="chip" data-filter="requesting">申請中</div>
    <div class="chip" data-filter="paid">已完成提領</div>
  </div>

  <div class="card">
    <table class="tbl responsive" id="tblHistory"><tbody></tbody></table>
    <div class="muted center" id="emptyTip" style="display:none">目前沒有符合條件的訂單。</div>
    <div class="sep"></div>
    <div class="sumline"><span>本頁合計</span><span id="sum" class="money">0 元</span></div>
  </div>

  <!-- 底部返回上一頁 -->
  <div class="center" style="margin-top:24px">
    <button class="btn-outline" onclick="location.href='https://chihang-go.com/driver_member/'">◀ 返回上一頁</button>
  </div>
</div>

<!-- 訂單詳情彈窗 -->
<div class="modal" id="modalDetail" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
    <div class="modal-head">
      <h2 id="mdTitle" class="modal-title">訂單詳情</h2>
      <button class="modal-close" id="modalClose" type="button" aria-label="關閉">×</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
(()=> {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const L = localStorage, S = sessionStorage;

  const acc = S.getItem('driverAccount') || 'driverdemo';
  const ORD_KEY = `driver_orders_${acc}`;
  const PAY_MAP_KEY = `driver_payout_status_${acc}`;

  const readObj = k => { try{ return JSON.parse(L.getItem(k)||'{}') }catch{ return {} } };
  const writeObj = (k,v) => L.setItem(k, JSON.stringify(v||{}));
  const readArr = k => JSON.parse(L.getItem(k)||'[]');
  const writeArr = (k,v) => L.setItem(k, JSON.stringify(v||[]));
  const fmt = iso => iso ? new Date(iso).toLocaleString('zh-TW',{hour12:false}) : '-';
  const money = n => `${Number(n||0).toLocaleString()} 元`;

  /* ========= 產生標準 CHyyyyMMddXXXX 編號 ========= */
  const genId = (y,m,d,i) => `CH${y}${String(m).padStart(2,'0')}${String(d).padStart(2,'0')}${String(i).padStart(4,'0')}`;

  /* ========= Demo 種子 ========= */
  (function seed(){
    const list = readArr(ORD_KEY);
    const map  = readObj(PAY_MAP_KEY);
    const upsert = (o, payout='unreq')=>{
      const i = list.findIndex(x=>x.orderId===o.orderId);
      if(i>=0) list[i]=o; else list.push(o);
      map[o.orderId] = payout;
    };
    upsert({
      orderId: genId(2025,9,30,1), status:'done', type:'接機', date:'2025-09-30 09:20', total:1200,
      detail:{ pickup:'桃園機場 T1', dropoff:'台北車站', flight:'CI102', pax:{adult:1}, pay:'現金' },
      audit:{completedAt:'2025-09-30T10:12:00+08:00'}
    }, 'unreq');
    upsert({
      orderId: genId(2025,10,1,2), status:'done', type:'送機', date:'2025-10-01 06:30', total:1500,
      detail:{ pickup:'板橋', dropoff:'桃園機場 T2', pax:{adult:2,child:1}, pay:'現金' },
      audit:{completedAt:'2025-10-01T06:57:00+08:00'}
    }, 'requesting');
    upsert({
      orderId: genId(2025,10,5,3), status:'done', type:'市區接送', date:'2025-10-05 20:00', total:980,
      detail:{ pickup:'信義區', dropoff:'小巨蛋', pax:{adult:3}, pay:'Line Pay' },
      audit:{completedAt:'2025-10-05T20:27:00+08:00'}
    }, 'paid');
    writeArr(ORD_KEY, list);
    writeObj(PAY_MAP_KEY, map);
  })();

  const orders = readArr(ORD_KEY);
  const payoutMap = readObj(PAY_MAP_KEY);
  const tbody = $('#tblHistory tbody');
  const emptyTip = $('#emptyTip');
  const sumEl = $('#sum');

  /* ========= 生成年月選項 ========= */
  const years = [...new Set(orders.map(o => (o.date||'').slice(0,4)))].filter(Boolean).sort((a,b)=>b-a);
  const yearSel = $('#yearFilter'), monthSel = $('#monthFilter');
  years.forEach(y => yearSel.insertAdjacentHTML('beforeend', `<option value="${y}">${y} 年</option>`));
  for(let m=1;m<=12;m++) monthSel.insertAdjacentHTML('beforeend', `<option value="${String(m).padStart(2,'0')}">${m} 月</option>`);

  /* ========= 列表渲染 ========= */
  function rowHTML(o){
    const completedAt = o?.audit?.completedAt;
    return `
      <tr class="order-row" data-id="${o.orderId}">
        <td class="t-id">${o.orderId}</td>
        <td class="t-right"><span class="badge">${o.type||''}</span></td>
        <td>完成時間</td>
        <td class="t-right">${fmt(completedAt)}</td>
        <td>金額</td>
        <td class="t-right">${money(o.total)}</td>
      </tr>
    `;
  }

  function renderList(kind, year, month){
    let data = orders.filter(o=>{
      const y = (o.date||'').slice(0,4);
      const m = (o.date||'').slice(5,7);
      return (!year || y===year) && (!month || m===month);
    });
    if(kind==='unreq') data = data.filter(o => (payoutMap[o.orderId]||'unreq')==='unreq');
    if(kind==='requesting') data = data.filter(o => payoutMap[o.orderId]==='requesting');
    if(kind==='paid') data = data.filter(o => payoutMap[o.orderId]==='paid');
    data.sort((a,b)=> new Date(b.audit?.completedAt||b.date) - new Date(a.audit?.completedAt||a.date));
    tbody.innerHTML = data.map(rowHTML).join('');
    emptyTip.style.display = data.length?'none':'block';
    sumEl.textContent = money(data.reduce((s,o)=>s+Number(o.total||0),0));
  }

  /* ========= 邏輯控制：先選時間，再開啟篩選 ========= */
  let selectedYear='', selectedMonth='', selectedKind='all';
  const statusFilters = $('#statusFilters');

  yearSel.addEventListener('change', ()=>{
    selectedYear = yearSel.value;
    tryShowFilters();
  });
  monthSel.addEventListener('change', ()=>{
    selectedMonth = monthSel.value;
    tryShowFilters();
  });

  function tryShowFilters(){
    if(selectedYear && selectedMonth){
      statusFilters.style.display='flex';
      renderList(selectedKind, selectedYear, selectedMonth);
    }
  }

  document.addEventListener('click', e=>{
    const chip = e.target.closest?.('.chip');
    if(chip){
      selectedKind = chip.dataset.filter;
      $$('.chip').forEach(c=>c.classList.toggle('active', c===chip));
      renderList(selectedKind, selectedYear, selectedMonth);
    }
  });

  /* ========= 詳情彈窗 ========= */
  const modal = $('#modalDetail'), modalBody = $('#modalBody');
  const openModal = () => modal.classList.add('active');
  const closeModal = () => modal.classList.remove('active');
  $('#modalClose').addEventListener('click', closeModal);
  document.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
   document.addEventListener('click',(e)=>{
    const row = e.target.closest?.('.order-row');
    if(!row) return;
    const id = row.dataset.id;
    const o = orders.find(x=>x.orderId===id);
    if(!o) return;

    const d = o.detail||{}, pax=d.pax||{};
    const paxLine = (pax.adult!=null||pax.child!=null) ? `大人 ${pax.adult||0}、小孩 ${pax.child||0}` : (d.passengers ?? '-');

    const fareLines=(d.fareItems||[]).map(i=>`<div class="kv"><div class="key">${i.name} ×${i.qty}</div><div class="val t-right">${money(i.amount)}</div></div>`).join('');
    const discountLine=d.discount&&Number(d.discount)>0?`<div class="kv"><div class="key">折扣</div><div class="val t-right" style="color:#E34A4A">- ${money(d.discount)}</div></div>`:'';

    modalBody.innerHTML = `
      <!-- 訂單基本資訊 -->
      <div class="kv"><div class="key">訂單編號</div><div class="val" style="font-variant-numeric:tabular-nums">${o.orderId}</div></div>
      <div class="kv"><div class="key">狀態</div><div class="val">${o.status==='done'?'已完成':(o.status==='ing'?'進行中':'已取消')}</div></div>
      <div class="kv"><div class="key">服務類型</div><div class="val">${o.type||'-'}</div></div>
      <div class="kv"><div class="key">預約時間</div><div class="val">${o.date||'-'}</div></div>
      <div class="kv"><div class="key">車型</div><div class="val">${d.carType||'-'}</div></div>
      <div class="sep"></div>

      <!-- 行程資料 -->
      <div class="kv"><div class="key">上車地點／時間</div><div class="val">${d.pickup||'-'}</div></div>
      <div class="kv"><div class="key">下車地點</div><div class="val">${d.dropoff||'-'}</div></div>
      <div class="kv"><div class="key">航班／船班</div><div class="val">${d.flight||'-'}</div></div>
      <div class="kv"><div class="key">乘客人數</div><div class="val">${paxLine}</div></div>
      <div class="kv"><div class="key">兒童座椅</div><div class="val">${d.childSeat||0} 張</div></div>
      <div class="kv"><div class="key">行李件數</div><div class="val">${d.luggage||0} 件</div></div>
      <div class="kv"><div class="key">舉牌服務</div><div class="val">${d.sign?.need?'是':'否'} ${d.sign?.text?`（${d.sign.text}）`:''}</div></div>
      <div class="sep"></div>

      <!-- 費用明細 -->
      ${fareLines||'<div class="muted">無費用明細</div>'}
      ${discountLine}
      <div class="kv"><div class="key">應付總額</div><div class="val" style="color:#2B7CFF;font-weight:900">${money(o.total)}</div></div>
      <div class="sep"></div>

      <!-- 付款與備註 -->
      <div class="kv"><div class="key">付款方式</div><div class="val">${d.pay||'-'}</div></div>
      <div class="kv"><div class="key">備註內容</div><div class="val">${d.note||'-'}</div></div>
      ${o.status==='done' ? `<div class="kv"><div class="key">完成時間</div><div class="val timestamp">${fmt(o?.audit?.completedAt)}</div></div>`:''}
    `;
    openModal();
  });
})();
</script>
</body>
</html>