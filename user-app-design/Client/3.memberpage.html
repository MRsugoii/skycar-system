<!-- æœƒå“¡é é¢ï¼ˆdemo å¸³è™Ÿ demo/123456ï½œé€²è¡Œä¸­è¨‚å–®ï¼šå¯é–‹å•Ÿè©³æƒ…ä¸¦ã€Œç”³è«‹é€€æ¬¾ã€ï½œç§»é™¤åˆªé™¤ç¤ºç¯„ï¼‰ -->
<!doctype html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>æœƒå“¡é é¢</title>
<style>
:root{ --teal:#2B7CFF; --text:#051D4B; --muted:#6b7b80; --line:#e7f0f1; --field:#B7C1CC; --bg:#f6f8fb }
html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,"Noto Sans TC",Arial;color:var(--text);-webkit-text-size-adjust:none}
#orders-app{width:390px;max-width:390px;margin:0 auto;padding:0 16px 40px}

.h1{font-size:26px;font-weight:900;margin:50px 0 6px;text-align:center}
.h2{font-size:15px;color:var(--muted);text-align:center;margin:0 0 16px}
.card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:16px 16px 14px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
.lbl{font-weight:800}
.muted{color:var(--muted);font-size:12px}
.grid{display:grid;gap:10px}

/* Inputsï¼ˆå«å½ˆçª—å…§æ¬„ä½ï¼‰*/
#orders-app .ipt, .modal-box .ipt,
#orders-app select.ipt, .modal-box select.ipt,
#orders-app textarea.ipt, .modal-box textarea.ipt {
  width:100%;
  padding:12px;
  font-size:15px;
  background:#fff!important;
  border:1px solid var(--field)!important;
  border-radius:16px!important;
  -webkit-appearance:none;
  appearance:none;
  box-shadow:none!important;
  background-clip:padding-box;
}
#orders-app .ipt:focus, .modal-box .ipt:focus {
  border-color:var(--teal)!important;
  box-shadow:0 0 0 2px rgba(43,124,255,.12)!important;
  outline:none!important;
}

/* Buttons */
#orders-app .btn,#orders-app button,#orders-app a.btn{
  display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;border-radius:50px!important;background:#2B7CFF!important;color:#fff!important;border:1px solid #2B7CFF!important;
  font-weight:900;letter-spacing:.02em;line-height:1;text-decoration:none;cursor:pointer;transition:.2s;
}
#orders-app .btn[variant="ghost"]{background:#fff!important;color:var(--teal)!important;border:1px solid var(--teal)!important}
.actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}

/* è¨‚å–®è¡¨ï¼šæ‰‹æ©Ÿå¡ç‰‡å¼ */
.tbl{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}
.tbl th,.tbl td{padding:10px 8px;border:1px solid var(--line);background:#fff}
.tbl thead{display:none} /* æ‰‹æ©Ÿè—è¡¨é ­ */
.tbl.responsive tbody>tr{
  display:grid;grid-template-columns:1fr auto;gap:6px;border:1px solid var(--line);
  border-radius:12px;padding:10px;background:#fff;
}
.tbl.responsive tbody>tr td{border:none;padding:0;background:transparent;white-space:normal;word-break:break-word;overflow-wrap:anywhere}
.tbl.responsive td[data-col="id"]{grid-column:1/2;font-weight:900;font-size:16px;letter-spacing:.3px}
.tbl.responsive td[data-col="amount"]{grid-column:2/3;justify-self:end;font-weight:900}
.tbl.responsive td[data-col="type"],.tbl.responsive td[data-col="date"]{grid-column:1/2;color:#2b3b55}
.tbl.responsive td[data-col="status"]{grid-column:2/3;justify-self:end}
.order-row{cursor:pointer}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.badge.ing{background:#f4f8ff} .badge.done{background:#f3fbf5} .badge.cancel{background:#fff6f6}

/* å„ªæƒ åˆ¸ */
.coupon{border:1px dashed var(--teal);border-radius:14px;padding:12px;display:grid;gap:8px;background:#fbfdff}
.coupon .top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.coupon .code{font-weight:900;color:var(--teal);font-size:18px;letter-spacing:.3px}
.coupon .title{font-weight:800}
.coupon .terms{color:var(--muted)}
.coupon .row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}

/* Modalï¼šæ‰‹æ©Ÿå°ºå¯¸ï¼‹å…§æ»¾å‹• */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.28);z-index:9999;padding:12px}
.modal.active{display:flex}
.modal-box{
  width:100%;max-width:390px;max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:18px;padding:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.08)
}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.modal-close{cursor:pointer;font-size:20px;color:var(--muted);font-weight:700;background:transparent;border:0}

/* è¿”å›éµ */
.back{position:fixed;left:10px;top:10px;z-index:10;width:38px;height:38px;border-radius:50%;background:#fff;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.back svg{width:20px;height:20px;stroke:var(--teal)}

/* Key-Value */
.sep{height:1px;background:var(--line);margin:12px 0}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px}
.kv .key{font-weight:800}
.kv .val{overflow-wrap:anywhere}

/* ç™»å‡ºé€£çµ */
.logout-link{display:block;margin:12px auto 0;color:var(--teal);text-decoration:underline;cursor:pointer}
</style>
</head>
<body>

<button class="back" id="btnBack" aria-label="è¿”å›ä¸Šä¸€é ">
  <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
</button>

<div id="orders-app">
  <div class="h1">æœƒå“¡é é¢</div>
  <div class="h2" id="welcome">æ­¡è¿å›ä¾†</div>

  <!-- æœƒå“¡æ¦‚è¦ -->
  <div class="card" id="profileView">
    <div class="grid">
      <div class="kv"><div class="key">å¸³æˆ¶</div><div class="val" id="v_acc">â€”</div></div>
      <div class="kv"><div class="key">å§“å</div><div class="val" id="v_name">â€”</div></div>
      <div class="kv"><div class="key">ç”Ÿæ—¥</div><div class="val" id="v_birth">â€”</div></div>
      <div class="kv"><div class="key">é›»è©±</div><div class="val" id="v_phone">â€”</div></div>
      <div class="kv"><div class="key">åœ°å€</div><div class="val" id="v_addr">â€”</div></div>
      <div class="kv"><div class="key">Email</div><div class="val" id="v_mail">â€”</div></div>
      <div class="kv"><div class="key">Line ID</div><div class="val" id="v_line">â€”</div></div>
      <div class="kv"><div class="key">WhatsApp</div><div class="val" id="v_wa">â€”</div></div>
    </div>
    <div class="actions" style="justify-content:center"><button id="btnEdit" class="btn" type="button">ç·¨è¼¯</button></div>
  </div>

  <!-- çµ±è¨ˆ -->
  <div class="card">
    <div class="grid">
      <div class="kv"><div class="key">ç´¯ç©æ¶ˆè²»</div><div class="val" id="v_spent">NT$ 0</div></div>
      <div class="kv"><div class="key">ç´¯ç©è¶Ÿæ•¸</div><div class="val" id="v_trips">0 è¶Ÿ</div></div>
      <div class="kv"><div class="key">æœƒå“¡ç­‰ç´š</div><div class="val" id="v_level">â€”</div></div>
    </div>
  </div>

  <!-- å„ªæƒ åˆ¸ -->
  <div class="card" id="couponBox">
    <div class="lbl" style="margin-bottom:8px">å¯ç”¨å„ªæƒ åˆ¸</div>
    <div id="couponList" class="grid"></div>
    <div class="muted">å·²ä½¿ç”¨æˆ–éæœŸçš„å„ªæƒ åˆ¸ä¸æœƒé¡¯ç¤ºã€‚</div>
  </div>

  <!-- é€²è¡Œä¸­è¨‚å–® -->
  <div class="card">
    <div class="lbl" style="margin-bottom:8px">é€²è¡Œä¸­çš„è¨‚å–®</div>
    <table class="tbl responsive" id="tblOngoing">
      <thead><tr><th>è¨‚å–®ç·¨è™Ÿ</th><th>é¡å‹</th><th>æ—¥æœŸ/æ™‚é–“</th><th>ç‹€æ…‹</th><th>é‡‘é¡</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- æ–°å¢ç´…è‰²ã€Œç·Šæ€¥è¯çµ¡ã€æŒ‰éˆ•ï¼ˆè¡¨æ ¼ä¸‹æ–¹ã€æç¤ºæ–‡å­—ä¸Šæ–¹ï¼‰ -->
    <div class="actions" style="justify-content:center;margin-top:10px">
      <button class="btn" id="btnEmergency" style="background:#E34A4A!important;border-color:#E34A4A!important;color:#fff!important;">ç·Šæ€¥è¯çµ¡</button>
    </div>

    <div class="muted">é»æ“Šåˆ—å¯æŸ¥çœ‹è©³æƒ…ï¼Œäº¦å¯ç”³è«‹é€€æ¬¾ã€‚</div>
  </div>

  <!-- æ­·å²è¨‚å–® -->
  <div class="card">
    <div class="lbl" style="margin-bottom:8px">æ­·å²è¨‚å–®</div>
    <table class="tbl responsive" id="tblHistory">
      <thead><tr><th>è¨‚å–®ç·¨è™Ÿ</th><th>é¡å‹</th><th>æ—¥æœŸ/æ™‚é–“</th><th>ç‹€æ…‹</th><th>é‡‘é¡</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="muted">åŒ…å«å·²å®Œæˆèˆ‡å·²å–æ¶ˆçš„è¨‚å–®ã€‚</div>
  </div>

  <!-- åº•éƒ¨å‹•ä½œ -->
  <div class="card" style="text-align:center">
    <a class="btn" id="btnBook" href="https://chihang-go.com/user_online_appointment/">é ç´„æœå‹™</a>
    <div class="logout-link" id="btnLogout">æœƒå“¡ç™»å‡º</div>
  </div>
</div>

<!-- è¨‚å–®è©³æƒ… Modal -->
<div class="modal" id="modalDetail" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
    <div class="modal-head">
      <h2 id="mdTitle" style="font-size:18px;font-weight:900;margin:0;color:var(--text)">è¨‚å–®è©³æƒ…</h2>
      <button class="modal-close" id="modalClose" type="button" aria-label="é—œé–‰">Ã—</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- ç·¨è¼¯æœƒå“¡ Modal -->
<div class="modal" id="modalEdit" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="meTitle">
    <div class="modal-head">
      <h2 id="meTitle" style="font-size:18px;font-weight:900;margin:0;color:var(--text)">ç·¨è¼¯æœƒå“¡è³‡æ–™</h2>
      <button class="modal-close" id="editClose" type="button" aria-label="é—œé–‰">Ã—</button>
    </div>
    <div class="grid" id="editForm">
      <div class="grid"><span class="lbl">å¸³æˆ¶ï¼ˆä¸å¯æ›´æ”¹ï¼‰</span><input id="e_acc" class="ipt" disabled></div>
      <div class="grid"><span class="lbl">å§“å</span><input id="e_name" class="ipt" placeholder="å§“å"></div>
      <div class="grid"><span class="lbl">ç”Ÿæ—¥</span><input id="e_birth" class="ipt" type="date"></div>
      <div class="grid"><span class="lbl">é›»è©±</span><input id="e_phone" class="ipt" type="tel" inputmode="numeric" placeholder="09xxxxxxxx"></div>
      <div class="grid"><span class="lbl">åœ°å€</span><input id="e_addr" class="ipt" placeholder="å¸‚ï¼å€ï¼è·¯ï¼è™Ÿâ€¦"></div>
      <div class="grid"><span class="lbl">Email</span><input id="e_mail" class="ipt" type="email" placeholder="example@mail.com"></div>
      <div class="grid"><span class="lbl">Line ID</span><input id="e_line" class="ipt" placeholder="@ æˆ– ID"></div>
      <div class="grid"><span class="lbl">WhatsApp</span><input id="e_wa" class="ipt" placeholder="é›»è©±æˆ–å¸³è™Ÿ"></div>
      <!-- è®Šæ›´å¯†ç¢¼ï¼ˆé¸å¡«ï¼‰ -->
<div class="sep"></div>
<div class="grid"><span class="lbl">ç›®å‰å¯†ç¢¼</span>
  <input id="e_pwd_current" class="ipt" type="password" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼">
  <div class="muted">è‹¥æ›¾æœªæ”¹éï¼Œé è¨­ç‚ºæ‚¨çš„æ‰‹æ©Ÿè™Ÿã€‚</div>
</div>
<div class="grid"><span class="lbl">æ–°å¯†ç¢¼</span>
  <input id="e_pwd_new" class="ipt" type="password" placeholder="è‡³å°‘ 6 ç¢¼">
</div>
<div class="grid"><span class="lbl">ç¢ºèªæ–°å¯†ç¢¼</span>
  <input id="e_pwd_new2" class="ipt" type="password" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
</div>
      <div class="actions" style="margin-top:6px;justify-content:flex-end"><button id="btnSaveEdit" class="btn" type="button">å„²å­˜</button></div>
    </div>
  </div>
</div>

<script>
(()=> {
  const $ = s => document.querySelector(s);
  const S = sessionStorage, L = localStorage;

  /* é€€æ¬¾é ï¼ˆæš«ç”¨åŸå–æ¶ˆè¨‚å–®è·¯ç”±ï¼›è‹¥æœ‰å°ˆå±¬é€€æ¬¾é è«‹æ›¿æ›æ­¤ URLï¼‰ */
  const ROUTE_REFUND='https://chihang-go.com/user_cancel_order/';
  const ROUTE_HOME='https://chihang-go.com/';
  const ROUTE_APPOINT='https://chihang-go.com/user_online_appointment/';

  $('#btnBack').addEventListener('click',()=>{ if(document.referrer) history.back(); else location.href=ROUTE_HOME; });

  /* å¼·åˆ¶å°å‘é ç´„é ï¼šé¿å…å¤–éƒ¨ç¨‹å¼æ””æˆª <a> click */
  document.getElementById('btnBook').addEventListener('click',(e)=>{ e.preventDefault(); window.location.href = ROUTE_APPOINT; });

  const safeParse = s => { try{ return JSON.parse(s||'{}') }catch{ return {} } };
  const readUser = acc => safeParse(L.getItem(`user_${acc}`));
  const writeUser = (acc, obj) => L.setItem(`user_${acc}`, JSON.stringify(obj||{}));
  const readOrders = acc => JSON.parse(L.getItem(`orders_${acc}`)||'[]');
  const writeOrders = (acc, list) => L.setItem(`orders_${acc}`, JSON.stringify(list||[]));

  /* Demo seedï¼šdemo/123456 */
  (function seed(){
    if(!S.getItem('memberAccount')) S.setItem('memberAccount','demo');

    if(!L.getItem('user_demo')){
      writeUser('demo',{
        account:'demo', password:'123456', displayName:'ç¤ºç¯„ç”¨æˆ¶',
        birthday:'1995-07-27', email:'demo@example.com', address:'å°ä¸­å¸‚è¥¿å±¯å€â€¦',
        phone:'0912345678', lineId:'@demo', whatsappId:'0912345678',
        totalSpent:7800, totalTrips:3, level:'ä¸€èˆ¬æœƒå“¡'
      });
    }
    if(!L.getItem('orders_demo')){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  const orderId = `CH${y}${m}${d}0001`;

  writeOrders('demo',[
    { orderId: orderId, status:'ing', type:'æ¥æ©Ÿ', date:`${y}-${m}-${d} 21:10`, total:2200,
      detail:{ pickup:'æ¡ƒåœ’æ©Ÿå ´ T2 åˆ°é” 21:10', dropoff:'å°ä¸­å¸‚å—å±¯å€â€¦', flight:'BR186', passengers:2,
               items:[{name:'æ©Ÿå ´æ¥é€ï¼ˆTPEâ†’å—å±¯ï¼‰',qty:1,unitPrice:2400}], discount:200, pay:'Line Pay',
               seats:{rear:0,front:1,booster:1}, luggage:{s20:0,s25:1,s28:1}, signage:true, signageText:'ç‹å°æ˜', carName:'HONDA Odyssey'} },
    { orderId:`CH${y}${m}${d}0002`, status:'done', type:'é€æ©Ÿ', date:`${y}-${m}-${d} 05:30`, total:2400,
      detail:{ pickup:'å°ä¸­å¸‚è¥¿å±¯å€â€¦ 05:30', dropoff:'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T1', flight:'CI011', passengers:3,
               items:[{name:'æ©Ÿå ´æ¥é€ï¼ˆè¥¿å±¯â†’TPEï¼‰',qty:1,unitPrice:2200},{name:'åŠ å¤§å‹è¡Œæ',qty:1,unitPrice:200}],
               pay:'ä¿¡ç”¨å¡', note:'éœ€è¦å…’ç«¥åº§æ¤…', seats:{rear:1,front:0,booster:0}, luggage:{s20:1,s25:1,s28:0}, signage:false, carName:'TOYOTA Wish'} }
  ]);
}

    /* demo å„ªæƒ åˆ¸ */
    if(!L.getItem('coupons_demo')){
      const now=Date.now(), day=86400000;
      L.setItem('coupons_demo', JSON.stringify([
        {code:'WELCOME200', title:'æ–°æˆ¶æŠ˜æŠµ 200', terms:'å–®ç­†æ»¿ 2000 å¯ç”¨', expireAt:now+30*day, used:false},
        {code:'VIP500', title:'æœƒå“¡å›é¥‹ 500', terms:'å–®ç­†æ»¿ 3500 å¯ç”¨', expireAt:now+10*day, used:false}
      ]));
    }
  })();

  const getAcc = () => S.getItem('memberAccount') || 'demo';

function renderProfile(){
  const acc=getAcc(), u=readUser(acc)||{};
  $('#welcome').textContent='æ­¡è¿å›ä¾† ' + (u.displayName||acc);
  $('#v_acc').textContent=u.account||acc;
  $('#v_name').textContent=u.displayName||'â€”';
  $('#v_birth').textContent=u.birthday||'â€”';
  $('#v_phone').textContent=u.phone||'â€”';
  $('#v_addr').textContent=u.address||'â€”';
  $('#v_mail').textContent=u.email||'â€”';
  $('#v_line').textContent=u.lineId||'â€”';
  $('#v_wa').textContent=u.whatsappId||'â€”';
  $('#v_spent').textContent='NT$ ' + Number(u.totalSpent||0).toLocaleString();
  $('#v_trips').textContent=Number(u.totalTrips||0)+' è¶Ÿ';

  // ğŸ”½ æ–°å¢é€™æ®µï¼šè‡ªå‹•åˆ¤æ–·æœƒå“¡ç­‰ç´š
  const spent = Number(u.totalSpent || 0);
  let level = 'C'; // é è¨­ç‚º C ç´š
  if (spent >= 100000) level = 'A';       // 10è¬ä»¥ä¸Šï¼šA ç´š
  else if (spent >= 10000) level = 'B';   // 1è¬ä»¥ä¸Šï¼šB ç´š
  $('#v_level').textContent = level;      // é¡¯ç¤º A / B / C
}

  /* å„ªæƒ åˆ¸ */
  function fmtDate(ts){ try{ const d=new Date(Number(ts)); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` }catch{return ''} }
  function renderCoupons(){
    const acc=getAcc(), list=(JSON.parse(L.getItem('coupons_'+acc)||'[]')||[]).filter(c=>!c.used && c.expireAt>Date.now());
    const box=$('#couponList');
    if(!list.length){ box.innerHTML='<div class="muted">ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸ã€‚</div>'; return; }
    box.innerHTML=list.map(c=>`
      <div class="coupon">
        <div class="top">
          <div class="code">${c.code}</div>
          <div class="title">${c.title||''}</div>
        </div>
        <div class="terms">${c.terms||''}</div>
        <div class="row">
          <div class="muted">æœ‰æ•ˆæœŸé™ï¼š${fmtDate(c.expireAt)}</div>
          <button class="btn" variant="ghost" data-act="copy" data-code="${c.code}">è¤‡è£½åºè™Ÿ</button>
        </div>
      </div>`).join('');
  }
  document.addEventListener('click',(e)=>{ const b=e.target.closest?.('button[data-act]'); if(b?.dataset.act==='copy'){ navigator.clipboard?.writeText(b.dataset.code).then(()=>alert('å·²è¤‡è£½ï¼š'+b.dataset.code)); } });

  /* è¨‚å–®åˆ—è¡¨ï¼ˆå·²ç§»é™¤ã€Œåˆªé™¤ï¼ˆç¤ºç¯„ï¼‰ã€ï¼‰ */
function renderOrders(){
  const acc=getAcc(), list=readOrders(acc)||[];
  const ongoing=list.filter(o=>o.status==='ing');
  const history=list.filter(o=>o.status!=='ing');

  fill('#tblOngoing tbody', ongoing, 'ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„è¨‚å–®');
  fill('#tblHistory tbody', history, 'å°šç„¡æ­·å²è¨‚å–®');

  function fill(sel, arr, emptyText){
    const tbody=document.querySelector(sel);
    tbody.innerHTML = arr.length ? arr.map(rowHTML).join('') 
      : `<tr class="order-row"><td data-col="id">${emptyText}</td><td data-col="type"></td><td data-col="date"></td><td data-col="status"></td><td data-col="amount"></td></tr>`;
  }

  function rowHTML(o){
    // ä¿æŒåŸå§‹è¨‚å–®ç·¨è™Ÿï¼Œé¿å…å‚³åˆ°é€€æ¬¾é å¾ŒæŠ“ä¸åˆ°
let displayId = o.orderId || '';

    const cls = o.status==='ing' ? 'ing' :
                o.status==='done' ? 'done' :
                (o.status==='refund' ? 'ing' : 'cancel'); // refund ç‹€æ…‹é¡¯ç¤ºè—è‰²å¾½ç« 
    const txt = o.status==='ing' ? 'é€²è¡Œä¸­' :
                o.status==='done' ? 'å·²å®Œæˆ' :
                o.status==='refund' ? 'é€€æ¬¾ä¸­' :
                o.status==='notapproved' ? 'é€€æ¬¾è¢«æ‹’' :
                o.status==='cancelled' ? 'å·²å–æ¶ˆ' : 'å·²å–æ¶ˆ';

    const icon = (o.status === 'cancelled')
  ? '<span style="color:#E34A4A;font-weight:900;">å–æ¶ˆ</span>'
  : (o.status === 'refund')
    ? '<span style="color:#2B7CFF;font-weight:900;">é€€æ¬¾ä¸­</span>'
    : (o.status === 'notapproved')
      ? '<span style="color:#999;font-weight:900;">æ‹’çµ•é€€æ¬¾</span>'
      : '';

return `<tr class="order-row" data-id="${o.orderId}">
  <td data-col="id">${displayId}</td>
  <td data-col="type">${o.type||''}</td>
  <td data-col="date">${o.date||''}</td>
  <td data-col="status"><span class="badge ${cls}">${txt}</span></td>
  <td data-col="amount" style="text-align:right">
    ${Number(o.total||0).toLocaleString()} å…ƒ
    ${icon ? `<div style="margin-top:4px;">${icon}</div>` : ''}
  </td>
</tr>`;

  }
}

  /* é»åˆ—çœ‹è©³æƒ…ï¼ˆmodalï¼‰ */
  const modal=$('#modalDetail'), modalBody=$('#modalBody');
  document.addEventListener('click',(e)=>{
    const row=e.target.closest?.('.order-row'); 
    if(!row) return;
    const acc=getAcc(), list=readOrders(acc)||[], o=list.find(x=>x.orderId===row.dataset.id);
    if(!o || !o.orderId) return;
    modalBody.innerHTML = buildDetail(o); openModal(modal); 
  });

  function buildDetail(o){
    const d=o.detail||{};
    const seats = d.seats || o.ride?.seats || {};
    const luggage = d.luggage || o.ride?.luggage || {};
    const signage = (d.signage ?? o.ride?.signage);
    const signageText = d.signageText || o.ride?.signageText || '';
    const carName = d.carName || d.car || o.ride?.selectedCar?.name || '';
    const items=(d.items||[]).map(it=>`
      <div style="display:flex;justify-content:space-between;gap:8px">
        <span style="overflow-wrap:anywhere">${it.name} Ã— ${it.qty}</span>
        <span>${(it.unitPrice*it.qty).toLocaleString()} å…ƒ</span>
      </div>`).join('');
    const discount=d.discount?`<div style="display:flex;justify-content:space-between"><span>æŠ˜æ‰£</span><span>- ${Number(d.discount).toLocaleString()} å…ƒ</span></div>`:'';
    const statusTxt=o.status==='ing'?'é€²è¡Œä¸­':(o.status==='done'?'å·²å®Œæˆ':'å·²å–æ¶ˆ');
    const statusCls=o.status==='ing'?'ing':(o.status==='done'?'done':'cancel');

    const seatLine = (seats.rear||seats.front||seats.booster) != null
      ? `å¾Œå‘ ${seats.rear||0}ï¼å‰å‘ ${seats.front||0}ï¼å¢é«˜ ${seats.booster||0}` : '';
    const lugLine = (luggage.s20||luggage.s25||luggage.s28) != null
      ? `20å‹ä»¥ä¸‹ ${luggage.s20||0}ï¼›21â€“25å‹ ${luggage.s25||0}ï¼›26â€“28å‹ ${luggage.s28||0}` : '';

    return `
      <div class="grid" style="gap:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">è¨‚å–®ç·¨è™Ÿ</div>
          <span class="badge ${statusCls}">${statusTxt}</span>
        </div>
        <div style="font-variant-numeric:tabular-nums">${o.orderId}</div>

        <div class="sep"></div>

        <div class="kv"><div class="key">æœå‹™é¡å‹</div><div class="val">${o.type||'-'}</div></div>
        <div class="kv"><div class="key">é ç´„æ™‚é–“</div><div class="val">${o.date||'-'}</div></div>
        ${carName ? `<div class="kv"><div class="key">è»Šå‹</div><div class="val">${carName}</div></div>` : ''}

        <div class="sep"></div>

        <div class="kv"><div class="key">ä¸Šè»Šåœ°é»/æ™‚é–“</div><div class="val">${d.pickup||'-'}</div></div>
        <div class="kv"><div class="key">ä¸‹è»Šåœ°é»</div><div class="val">${d.dropoff||'-'}</div></div>
        <div class="kv"><div class="key">èˆªç­/èˆ¹ç­</div><div class="val">${d.flight||'-'}</div></div>
        <div class="kv"><div class="key">ä¹˜å®¢äººæ•¸</div><div class="val">${d.passengers ?? '-'}</div></div>
        ${seatLine ? `<div class="kv"><div class="key">å…’ç«¥åº§æ¤…</div><div class="val">${seatLine}</div></div>` : ''}
        ${lugLine ? `<div class="kv"><div class="key">è¡Œæä»¶æ•¸</div><div class="val">${lugLine}</div></div>` : ''}
        ${signage !== undefined ? `<div class="kv"><div class="key">èˆ‰ç‰Œæœå‹™</div><div class="val">${signage ? ('éœ€è¦' + (signageText?`ï¼ˆ${signageText}ï¼‰`:'')) : 'ä¸éœ€è¦'}</div></div>` : ''}

        <div class="sep"></div>

        <div><b>è²»ç”¨æ˜ç´°</b>
          <div style="margin-top:6px">${items}${discount}
            <div style="display:flex;justify-content:space-between;font-weight:800;margin-top:6px">
              <span>æ‡‰ä»˜ç¸½é¡</span><span style="color:#2B7CFF">${Number(o.total||0).toLocaleString()} å…ƒ</span>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="kv"><div class="key">ä»˜æ¬¾æ–¹å¼</div><div class="val">${d.pay||'-'}</div></div>
        <div class="kv"><div class="key">å‚™è¨»</div><div class="val">${d.note||'-'}</div></div>

        ${o.status==='ing'
          ? `<div class="actions" style="justify-content:flex-end">
               <button class="btn" id="goRefund" data-order="${o.orderId}">ç”³è«‹é€€æ¬¾</button>
             </div>`
          : ''}
      </div>`;
  }

  /* ç”³è«‹é€€æ¬¾ï¼ˆè·³å»å¤–é ï¼Œå¸¶ä¸Šç›®å‰è¨‚å–®ï¼‰ */
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest?.('#goRefund'); if(!btn) return;
    const acc=getAcc(), list=readOrders(acc)||[], o=list.find(x=>x.orderId===btn.dataset.order);
    if(!o){ alert('æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™'); return; }
    try{
      S.setItem('activeOrder', JSON.stringify(o));
    }catch(e){}
    const ret='?return='+encodeURIComponent(location.href);
    closeModal($('#modalDetail')); location.assign(ROUTE_REFUND + ret);
  });

  // ç·¨è¼¯
  const modalEdit=document.getElementById('modalEdit');
  document.getElementById('btnEdit').addEventListener('click',()=>{
    const u=readUser(getAcc())||{};
    $('#e_acc').value=u.account||''; $('#e_name').value=u.displayName||'';
    $('#e_birth').value=u.birthday||''; $('#e_phone').value=u.phone||'';
    $('#e_addr').value=u.address||''; $('#e_mail').value=u.email||'';
    $('#e_line').value=u.lineId||''; $('#e_wa').value=u.whatsappId||'';
    openModal(modalEdit);
  });
  document.getElementById('btnSaveEdit').addEventListener('click',()=>{
  const acc=getAcc(), u=readUser(acc)||{};

  // 1) å…ˆåšè³‡æ–™æ¬„ä½æª¢æŸ¥
  const phone=($('#e_phone').value||'').replace(/\D/g,'');
  if(phone && !/^09\d{8}$/.test(phone)){ alert('æ‰‹æ©Ÿæ ¼å¼é ˆç‚º 09xxxxxxxx'); return; }

  // 2) å¯†ç¢¼è®Šæ›´ï¼ˆé¸å¡«ï¼‰ï¼šåªæœ‰åœ¨ä»»ä¸€å¯†ç¢¼æ¬„æœ‰å¡«æ™‚æ‰å•Ÿå‹•æª¢æŸ¥
  const cur = ($('#e_pwd_current').value||'').trim();
  const npw = ($('#e_pwd_new').value||'').trim();
  const npw2= ($('#e_pwd_new2').value||'').trim();
  let newPassword = null;

  if (cur || npw || npw2) {
    // å¿…é ˆä¸‰æ¬„éƒ½å¡«
    if(!cur || !npw || !npw2){ alert('è«‹å®Œæ•´å¡«å¯«ã€Œç›®å‰å¯†ç¢¼ï¼æ–°å¯†ç¢¼ï¼ç¢ºèªæ–°å¯†ç¢¼ã€'); return; }
    // ç›®å‰å¯†ç¢¼éœ€æ­£ç¢º
    if((u.password||'') !== cur){ alert('ç›®å‰å¯†ç¢¼ä¸æ­£ç¢º'); return; }
    // æ–°å¯†ç¢¼è¦å‰‡
    if(npw.length < 6){ alert('æ–°å¯†ç¢¼è‡³å°‘ 6 ç¢¼'); return; }
    if(npw !== npw2){ alert('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´'); return; }
    // å¯é¸ï¼šé¿å…èˆ‡èˆŠå¯†ç¢¼ç›¸åŒ
    if(npw === cur){ alert('æ–°å¯†ç¢¼ä¸å¯èˆ‡ç›®å‰å¯†ç¢¼ç›¸åŒ'); return; }

    newPassword = npw;
  }

  // 3) çµ„åˆæ›´æ–°è³‡æ–™
  const updated={...u,
    displayName:($('#e_name').value||'').trim(),
    birthday:$('#e_birth').value||'',
    phone,
    address:($('#e_addr').value||'').trim(),
    email:($('#e_mail').value||'').trim(),
    lineId:($('#e_line').value||'').trim(),
    whatsappId:($('#e_wa').value||'').trim()
  };
  if(newPassword) updated.password = newPassword; // åªæœ‰ä½¿ç”¨è€…æœ‰è®Šæ›´æ‰è¦†è“‹

  // 4) å¯«å…¥èˆ‡å›å¡«
  writeUser(acc,updated);
  closeModal(modalEdit);
  renderProfile();
  alert(newPassword ? 'å·²å„²å­˜ä¸¦æ›´æ–°å¯†ç¢¼' : 'å·²å„²å­˜æœƒå“¡è³‡æ–™');
});

  // ç™»å‡º
  document.getElementById('btnLogout').addEventListener('click',()=>{
    S.removeItem('jwt'); S.removeItem('memberAccount'); alert('æ‚¨å·²ç™»å‡º'); location.href='https://chihang-go.com/user_login/';
  });

  // modal helpers
  function openModal(m){ m.classList.add('active'); m.setAttribute('aria-hidden','false'); }
  function closeModal(m){ m.classList.remove('active'); m.setAttribute('aria-hidden','true'); }
  document.getElementById('modalClose').addEventListener('click',()=>closeModal($('#modalDetail')));
  document.getElementById('editClose').addEventListener('click',()=>closeModal(modalEdit));
  document.addEventListener('click',(e)=>{ if(e.target===$('#modalDetail')) closeModal($('#modalDetail')); if(e.target===modalEdit) closeModal(modalEdit); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeModal($('#modalDetail')); closeModal(modalEdit);} });

  // demoï¼šç·Šæ€¥è¯çµ¡ï¼ˆåƒ…ç¤ºç¯„ï¼Œä¸çœŸçš„æ’¥è™Ÿï¼‰
  document.addEventListener('click', (e) => {
    const btn = e.target.closest?.('#btnEmergency');
    if (!btn) return;
    alert('æ­£åœ¨æ’¥æ‰“å®¢æœé›»è©±ï¼š0800-000-000ï¼ˆç¤ºç¯„ç”¨ï¼‰');
  });

  // boot
  (function(){
  // --- DEMOï¼šä¿è­‰æœ‰ä¸€ç­†ã€Œé€²è¡Œä¸­ã€çš„è¨‚å–® ---
(function ensureDemoOngoing(){
  try{
    const acc = (sessionStorage.getItem('memberAccount') || 'demo');
    const list = JSON.parse(localStorage.getItem('orders_' + acc) || '[]');

// è‹¥æ²’æœ‰é€²è¡Œä¸­è¨‚å–®å°±å¡ä¸€ç­†
if (!list.some(o => o.status === 'ing')) {
  const now = new Date();
  const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');

  // âœ… è‡ªå‹•ç”¢ç”Ÿç•¶æ—¥æµæ°´è™Ÿï¼ˆé€™æ®µè¦æ”¾åœ¨å¤–é¢ï¼‰
  const sameDayOrders = list.filter(o => o.orderId && o.orderId.startsWith(`CH${y}${m}${d}`));
const lastSerial = sameDayOrders.length
  ? Math.max(...sameDayOrders.map(o => {
      // å–å‡ºæœ€å¾Œå››ä½æ•¸å­—ï¼ˆå³ä½¿èˆŠè³‡æ–™æœ‰ã€Œ-ã€ä¹Ÿèƒ½æ­£å¸¸è½‰æ›ï¼‰
      const match = o.orderId.match(/(\d{4})$/);
      return match ? Number(match[1]) : 0;
    }))
  : 0;
const nextSerial = String(lastSerial + 1).padStart(4, '0');
const orderId = `CH${y}${m}${d}${nextSerial}`;

  // âœ… ç„¶å¾Œé€™è£¡å†å»ºç«‹è¨‚å–®
  const order = {
    orderId: orderId,
    status: 'ing',
    type: 'æ¥æ©Ÿ',
    date: `${y}-${m}-${d} ${String(now.getHours()+1).padStart(2,'0')}:30`,
    total: 2200,
    detail:{
      pickup:'æ¡ƒåœ’æ©Ÿå ´ T2 åˆ°é” 22:30',
      dropoff:'å°ä¸­å¸‚å—å±¯å€å…¬ç›Šè·¯ xxx è™Ÿ',
      flight:'BR186',
      passengers:2,
      items:[{name:'æ©Ÿå ´æ¥é€ï¼ˆTPEâ†’å°ä¸­ï¼‰', qty:1, unitPrice:2200}],
      discount:0,
      pay:'ä¿¡ç”¨å¡',
      seats:{rear:0, front:1, booster:1},
      luggage:{s20:0, s25:1, s28:1},
      signage:true,
      signageText:'ç‹å°æ˜',
      carName:'TOYOTA Wish',
      note:'å¸æ©Ÿåˆ°é”å‰ 10 åˆ†é˜æœƒé›»è©±è¯ç¹«'
    }
  };
  list.unshift(order);
  localStorage.setItem('orders_' + acc, JSON.stringify(list));
}
  }catch(e){}
})();
    renderProfile(); renderCoupons(); renderOrders();
  })();
})();
</script>
</body>
</html>